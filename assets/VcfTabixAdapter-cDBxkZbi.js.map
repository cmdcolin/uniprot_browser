{"version":3,"file":"VcfTabixAdapter-cDBxkZbi.js","sources":["../../node_modules/@jbrowse/plugin-variants/esm/VcfTabixAdapter/VcfTabixAdapter.js"],"sourcesContent":["import { TabixIndexedFile } from '@gmod/tabix';\nimport VcfParser from '@gmod/vcf';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { fetchAndMaybeUnzipText, shorten2, updateStatus, } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport VcfFeature from '../VcfFeature';\nexport default class VcfTabixAdapter extends BaseFeatureDataAdapter {\n    async configurePre(_opts) {\n        const vcfGzLocation = this.getConf('vcfGzLocation');\n        const location = this.getConf(['index', 'location']);\n        const indexType = this.getConf(['index', 'indexType']);\n        const filehandle = openLocation(vcfGzLocation, this.pluginManager);\n        const isCSI = indexType === 'CSI';\n        const vcf = new TabixIndexedFile({\n            filehandle,\n            csiFilehandle: isCSI\n                ? openLocation(location, this.pluginManager)\n                : undefined,\n            tbiFilehandle: !isCSI\n                ? openLocation(location, this.pluginManager)\n                : undefined,\n            chunkCacheSize: 50 * 2 ** 20,\n        });\n        return {\n            vcf,\n            parser: new VcfParser({\n                header: await vcf.getHeader(),\n            }),\n        };\n    }\n    async configurePre2() {\n        if (!this.configured) {\n            this.configured = this.configurePre().catch((e) => {\n                this.configured = undefined;\n                throw e;\n            });\n        }\n        return this.configured;\n    }\n    async configure(opts) {\n        const { statusCallback = () => { } } = opts || {};\n        return updateStatus('Downloading index', statusCallback, () => this.configurePre2());\n    }\n    async getRefNames(opts = {}) {\n        const { vcf } = await this.configure(opts);\n        return vcf.getReferenceSequenceNames(opts);\n    }\n    async getHeader(opts) {\n        const { vcf } = await this.configure(opts);\n        return vcf.getHeader();\n    }\n    async getMetadata(opts) {\n        const { parser } = await this.configure(opts);\n        return parser.getMetadata();\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const { refName, start, end } = query;\n            const { statusCallback = () => { } } = opts;\n            const { vcf, parser } = await this.configure(opts);\n            await updateStatus('Downloading variants', statusCallback, () => vcf.getLines(refName, start, end, {\n                lineCallback: (line, fileOffset) => {\n                    observer.next(new VcfFeature({\n                        variant: parser.parseLine(line),\n                        parser,\n                        id: `${this.id}-vcf-${fileOffset}`,\n                    }));\n                },\n                ...opts,\n            }));\n            observer.complete();\n        }, opts.stopToken);\n    }\n    async getSources() {\n        const conf = this.getConf('samplesTsvLocation');\n        if (conf.uri === '' || conf.uri === '/path/to/samples.tsv') {\n            const { parser } = await this.configure();\n            return parser.samples.map(name => ({\n                name,\n            }));\n        }\n        else {\n            const txt = await fetchAndMaybeUnzipText(openLocation(conf, this.pluginManager));\n            const lines = txt.split(/\\n|\\r\\n|\\r/);\n            const header = lines[0].split('\\t');\n            const { parser } = await this.configure();\n            const metadataLines = lines\n                .slice(1)\n                .filter(f => !!f)\n                .map(line => {\n                const [name, ...rest] = line.split('\\t');\n                return {\n                    ...Object.fromEntries(header.slice(1).map((c, idx) => [c, rest[idx] || ''])),\n                    name: name,\n                };\n            });\n            const vcfSampleSet = new Set(parser.samples);\n            const metadataSet = new Set(metadataLines.map(r => r.name));\n            const metadataNotInVcfSamples = [...metadataSet].filter(f => !vcfSampleSet.has(f));\n            const vcfSamplesNotInMetadata = [...vcfSampleSet].filter(f => !metadataSet.has(f));\n            if (metadataNotInVcfSamples.length) {\n                console.warn(`There are ${metadataNotInVcfSamples.length} samples in metadata file (${metadataLines.length} lines) not in VCF (${parser.samples.length} samples):`, shorten2(metadataNotInVcfSamples.join(',')));\n            }\n            if (vcfSamplesNotInMetadata.length) {\n                console.warn(`There are ${vcfSamplesNotInMetadata.length} samples in VCF file (${parser.samples.length} samples) not in metadata file (${metadataLines.length} lines):`, shorten2(vcfSamplesNotInMetadata.map(m => m).join(',')));\n            }\n            return metadataLines.filter(f => vcfSampleSet.has(f.name));\n        }\n    }\n}\n"],"names":["VcfTabixAdapter","BaseFeatureDataAdapter","_opts","vcfGzLocation","location","indexType","filehandle","openLocation","isCSI","vcf","TabixIndexedFile","VcfParser","opts","statusCallback","updateStatus","parser","query","ObservableCreate","observer","refName","start","end","line","fileOffset","VcfFeature","conf","name","lines","fetchAndMaybeUnzipText","header","metadataLines","f","rest","c","idx","vcfSampleSet","metadataSet","r","metadataNotInVcfSamples","vcfSamplesNotInMetadata","shorten2","m"],"mappings":"oYAOe,MAAMA,UAAwBC,EAAAA,sBAAuB,CAChE,MAAM,aAAaC,EAAO,CACtB,MAAMC,EAAgB,KAAK,QAAQ,eAAe,EAC5CC,EAAW,KAAK,QAAQ,CAAC,QAAS,UAAU,CAAC,EAC7CC,EAAY,KAAK,QAAQ,CAAC,QAAS,WAAW,CAAC,EAC/CC,EAAaC,EAAAA,aAAaJ,EAAe,KAAK,aAAa,EAC3DK,EAAQH,IAAc,MACtBI,EAAM,IAAIC,EAAiB,CAC7B,WAAAJ,EACA,cAAeE,EACTD,eAAaH,EAAU,KAAK,aAAa,EACzC,OACN,cAAgBI,EAEV,OADAD,eAAaH,EAAU,KAAK,aAAa,EAE/C,eAAgB,GAAK,GAAK,EACtC,CAAS,EACD,MAAO,CACH,IAAAK,EACA,OAAQ,IAAIE,EAAU,CAClB,OAAQ,MAAMF,EAAI,UAAS,CAC3C,CAAa,CACb,CACI,CACA,MAAM,eAAgB,CAClB,OAAK,KAAK,aACN,KAAK,WAAa,KAAK,aAAY,EAAG,MAAO,GAAM,CAC/C,WAAK,WAAa,OACZ,CACV,CAAC,GAEE,KAAK,UAChB,CACA,MAAM,UAAUG,EAAM,CAClB,KAAM,CAAE,eAAAC,EAAiB,IAAM,CAAE,CAAC,EAAKD,GAAQ,CAAA,EAC/C,OAAOE,EAAAA,aAAa,oBAAqBD,EAAgB,IAAM,KAAK,cAAa,CAAE,CACvF,CACA,MAAM,YAAYD,EAAO,GAAI,CACzB,KAAM,CAAE,IAAAH,CAAG,EAAK,MAAM,KAAK,UAAUG,CAAI,EACzC,OAAOH,EAAI,0BAA0BG,CAAI,CAC7C,CACA,MAAM,UAAUA,EAAM,CAClB,KAAM,CAAE,IAAAH,CAAG,EAAK,MAAM,KAAK,UAAUG,CAAI,EACzC,OAAOH,EAAI,UAAS,CACxB,CACA,MAAM,YAAYG,EAAM,CACpB,KAAM,CAAE,OAAAG,CAAM,EAAK,MAAM,KAAK,UAAUH,CAAI,EAC5C,OAAOG,EAAO,YAAW,CAC7B,CACA,YAAYC,EAAOJ,EAAO,GAAI,CAC1B,OAAOK,EAAAA,iBAAiB,MAAOC,GAAa,CACxC,KAAM,CAAE,QAAAC,EAAS,MAAAC,EAAO,IAAAC,CAAG,EAAKL,EAC1B,CAAE,eAAAH,EAAiB,IAAM,CAAE,CAAC,EAAKD,EACjC,CAAE,IAAAH,EAAK,OAAAM,CAAM,EAAK,MAAM,KAAK,UAAUH,CAAI,EACjD,MAAME,EAAAA,aAAa,uBAAwBD,EAAgB,IAAMJ,EAAI,SAASU,EAASC,EAAOC,EAAK,CAC/F,aAAc,CAACC,EAAMC,IAAe,CAChCL,EAAS,KAAK,IAAIM,EAAW,CACzB,QAAST,EAAO,UAAUO,CAAI,EAC9B,OAAAP,EACA,GAAI,GAAG,KAAK,EAAE,QAAQQ,CAAU,EACxD,CAAqB,CAAC,CACN,EACA,GAAGX,CACnB,CAAa,CAAC,EACFM,EAAS,SAAQ,CACrB,EAAGN,EAAK,SAAS,CACrB,CACA,MAAM,YAAa,CACf,MAAMa,EAAO,KAAK,QAAQ,oBAAoB,EAC9C,GAAIA,EAAK,MAAQ,IAAMA,EAAK,MAAQ,uBAAwB,CACxD,KAAM,CAAE,OAAAV,CAAM,EAAK,MAAM,KAAK,UAAS,EACvC,OAAOA,EAAO,QAAQ,IAAIW,IAAS,CAC/B,KAAAA,CAChB,EAAc,CACN,KACK,CAED,MAAMC,GADM,MAAMC,yBAAuBrB,EAAAA,aAAakB,EAAM,KAAK,aAAa,CAAC,GAC7D,MAAM,YAAY,EAC9BI,EAASF,EAAM,CAAC,EAAE,MAAM,GAAI,EAC5B,CAAE,OAAAZ,CAAM,EAAK,MAAM,KAAK,UAAS,EACjCe,EAAgBH,EACjB,MAAM,CAAC,EACP,OAAOI,GAAK,CAAC,CAACA,CAAC,EACf,IAAIT,GAAQ,CACb,KAAM,CAACI,EAAM,GAAGM,CAAI,EAAIV,EAAK,MAAM,GAAI,EACvC,MAAO,CACH,GAAG,OAAO,YAAYO,EAAO,MAAM,CAAC,EAAE,IAAI,CAACI,EAAGC,IAAQ,CAACD,EAAGD,EAAKE,CAAG,GAAK,EAAE,CAAC,CAAC,EAC3E,KAAMR,CAC1B,CACY,CAAC,EACKS,EAAe,IAAI,IAAIpB,EAAO,OAAO,EACrCqB,EAAc,IAAI,IAAIN,EAAc,IAAIO,GAAKA,EAAE,IAAI,CAAC,EACpDC,EAA0B,CAAC,GAAGF,CAAW,EAAE,OAAOL,GAAK,CAACI,EAAa,IAAIJ,CAAC,CAAC,EAC3EQ,EAA0B,CAAC,GAAGJ,CAAY,EAAE,OAAOJ,GAAK,CAACK,EAAY,IAAIL,CAAC,CAAC,EACjF,OAAIO,EAAwB,QACxB,QAAQ,KAAK,aAAaA,EAAwB,MAAM,8BAA8BR,EAAc,MAAM,uBAAuBf,EAAO,QAAQ,MAAM,aAAcyB,EAAAA,SAASF,EAAwB,KAAK,GAAG,CAAC,CAAC,EAE/MC,EAAwB,QACxB,QAAQ,KAAK,aAAaA,EAAwB,MAAM,yBAAyBxB,EAAO,QAAQ,MAAM,mCAAmCe,EAAc,MAAM,WAAYU,WAASD,EAAwB,IAAIE,GAAKA,CAAC,EAAE,KAAK,GAAG,CAAC,CAAC,EAE7NX,EAAc,OAAOC,GAAKI,EAAa,IAAIJ,EAAE,IAAI,CAAC,CAC7D,CACJ,CACJ","x_google_ignoreList":[0]}
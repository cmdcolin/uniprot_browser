import{A as L}from"./AbortablePromiseCache-CQdc8xcb.js";import"./unzip-OY3UkAtn.js";import{L as d}from"./browser-DdKr-yeI.js";import{B as F}from"./index-CWy9Wmpn.js";import{ah as h,u as x,$ as I}from"./index-B3kPj2Rj.js";import{Q as k}from"./QuickLRU-C4m-IIJL.js";import{r as A}from"./rxjs-bJg6jVuh.js";function q(r,e){return r.offset+r.lineBytes*Math.floor(e/r.lineLength)+e%r.lineLength}async function E(r,e={}){const s=new TextDecoder("utf8");return Object.fromEntries(s.decode(await r.readFile(e)).split(/\r?\n/).map(t=>t.trim()).filter(t=>!!t).map(t=>t.split("	")).map(t=>{if(t[0]?.startsWith(">"))throw new Error("found > in sequence name, might have supplied FASTA file for the FASTA index");return[t[0],{name:t[0],length:+t[1],start:0,end:+t[1],offset:+t[2],lineLength:+t[3],lineBytes:+t[4]}]}))}class O{constructor({fasta:e,fai:s,path:t,faiPath:n}){if(e)this.fasta=e;else if(t)this.fasta=new d(t);else throw new Error("Need to pass filehandle for fasta or path to localfile");if(s)this.fai=s;else if(n)this.fai=new d(n);else if(t)this.fai=new d(`${t}.fai`);else throw new Error("Need to pass filehandle for  or path to localfile")}async _getIndexes(e){return this.indexes||(this.indexes=E(this.fai,e).catch(s=>{throw this.indexes=void 0,s})),this.indexes}async getSequenceNames(e){return Object.keys(await this._getIndexes(e))}async getSequenceSizes(e){const s={},t=await this._getIndexes(e);for(const n of Object.values(t))s[n.name]=n.length;return s}async getSequenceSize(e,s){return(await this._getIndexes(s))[e]?.length}async hasReferenceSequence(e,s){return!!(await this._getIndexes(s))[e]}async getResiduesByName(e,s,t,n){const a=(await this._getIndexes(n))[e];return a?this._fetchFromIndexEntry(a,s,t,n):void 0}async getSequence(e,s,t,n){return this.getResiduesByName(e,s,t,n)}async _fetchFromIndexEntry(e,s=0,t,n){let a=t;if(s<0)throw new TypeError("regionStart cannot be less than 0");if((a===void 0||a>e.length)&&(a=e.length),s>=a)return"";const i=q(e,s),o=q(e,a)-i;return new TextDecoder("utf8").decode(await this.fasta.read(o,i,n)).replace(/\s+/g,"")}}class j extends F.BaseSequenceAdapter{constructor(){super(...arguments),this.seqCache=new L({cache:new k({maxSize:200}),fill:async e=>{const{refName:s,start:t,end:n,fasta:a}=e;return a.getSequence(s,t,n)}})}async getRefNames(e){const{fasta:s}=await this.setup();return s.getSequenceNames()}async getRegions(e){const{fasta:s}=await this.setup(),t=await s.getSequenceSizes();return Object.keys(t).map(n=>({refName:n,start:0,end:t[n]}))}async setupPre(){const e=this.getConf("fastaLocation"),s=this.getConf("faiLocation");return{fasta:new O({fasta:h.openLocation(e,this.pluginManager),fai:h.openLocation(s,this.pluginManager)})}}async getHeader(){const e=this.getConf("metadataLocation");return e.uri===""||e.uri==="/path/to/fa.metadata.yaml"?null:h.openLocation(e,this.pluginManager).readFile("utf8")}async setup(){return this.setupP||(this.setupP=this.setupPre().catch(e=>{throw this.setupP=void 0,e})),this.setupP}getFeatures(e,s){const{statusCallback:t=()=>{},stopToken:n}=s||{},{refName:a,start:i,end:o}=e;return A.ObservableCreate(async u=>{await x.updateStatus2("Downloading sequence",t,n,async()=>{const{fasta:l}=await this.setup(),b=await l.getSequenceSize(a),p=Math.min(b||0,o),g=[],f=128e3,m=i-i%f,_=o+(f-o%f);for(let c=m;c<_;c+=f){const w={refName:a,start:c,end:c+f};I.checkStopToken(n);const S=await this.seqCache.get(JSON.stringify(w),{...w,fasta:l});if(!S)break;g.push(S)}const y=g.filter(c=>!!c).join("").slice(i-m).slice(0,o-i);y&&u.next(new x.SimpleFeature({id:`${a}-${i}-${p}`,data:{refName:a,start:i,end:p,seq:y}}))}),u.complete()})}}const R=Object.freeze(Object.defineProperty({__proto__:null,default:j},Symbol.toStringTag,{value:"Module"}));export{O as I,j as a,R as b};
//# sourceMappingURL=IndexedFastaAdapter-DCXiNjIS.js.map

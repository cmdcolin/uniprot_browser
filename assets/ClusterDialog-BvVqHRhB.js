import{o as R,a as o,j as e,D,B as u,$ as A,c as k,e as L,u as p,t as $,s as O,m as z,P as H,bw as F,aU as U,T as E,f as P,d as _}from"./index-BXtJZUZx.js";import{R as G}from"./RadioGroup-C73IwpQN.js";import{R as I}from"./Radio-CCrtrlYZ.js";const J=R(function({model:s,children:i,handleClose:r}){const[d,x]=o.useState(""),[h,a]=o.useState(!1),[f,j]=o.useState(),[g,C]=o.useState("");return e.jsxs(e.Fragment,{children:[e.jsxs(D,{children:[i,e.jsxs("div",{children:[h?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:d||"Loading..."}),e.jsx(u,{onClick:()=>{A.stopStopToken(g)},children:"Stop"})]}):null,f?e.jsx(k.ErrorMessage,{error:f}):null]})]}),e.jsxs(L,{children:[e.jsx(u,{variant:"contained",disabled:h,onClick:async()=>{try{j(void 0),x("Initializing"),a(!0);const c=p.getContainingView(s);if(!c.initialized)return;const{rpcManager:v}=p.getSession(s),{sourcesWithoutLayout:y,minorAlleleFrequencyFilter:w,lengthCutoffFilter:M,adapterConfig:m}=s;if(y){const S=$.getRpcSessionId(s),t=A.createStopToken();C(t);const n=await v.call(S,"MultiVariantClusterGenotypeMatrix",{regions:c.dynamicBlocks.contentBlocks,sources:y,minorAlleleFrequencyFilter:w,lengthCutoffFilter:M,sessionId:S,adapterConfig:m,stopToken:t,statusCallback:l=>{x(l)}});s.setLayout(n.order.map(l=>{const b=y[l];if(!b)throw new Error(`out of bounds at ${l}`);return b}))}r()}catch(c){!p.isAbortException(c)&&O(s)&&(console.error(c),j(c))}finally{a(!1),x(""),C("")}},children:"Run clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{r(),g&&A.stopStopToken(g)},children:"Cancel"})]})]})}),N=z()(s=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:s.spacing(4)}})),K=R(function({model:s,handleClose:i,children:r}){const{classes:d}=N(),[x,h]=o.useState(""),[a,f]=o.useState(),[j,g]=o.useState(),[C,c]=o.useState(!1),[v,y]=p.useLocalStorage("cluster-showAdvanced",!1),[w,M]=o.useState("single");o.useEffect(()=>{(async()=>{try{g(void 0),f(void 0),c(!0);const t=p.getContainingView(s);if(!t.initialized)return;const{rpcManager:n}=p.getSession(s),{sourcesWithoutLayout:l,minorAlleleFrequencyFilter:b,lengthCutoffFilter:V,adapterConfig:W}=s,T=$.getRpcSessionId(s),q=await n.call(T,"MultiVariantGetGenotypeMatrix",{regions:t.dynamicBlocks.contentBlocks,sources:l,minorAlleleFrequencyFilter:b,lengthCutoffFilter:V,sessionId:T,adapterConfig:W});f(q)}catch(t){!p.isAbortException(t)&&O(s)&&(console.error(t),g(t))}finally{c(!1)}})()},[s]);const m=a?`inputMatrix<-matrix(c(${Object.values(a).map(t=>t.join(",")).join(`,
`)}
),nrow=${Object.values(a).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(a).map(t=>`'${t}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${w}')
cat(resultClusters$order,sep='\\n')`:void 0,S=a?Object.entries(a).map(([t,n])=>[t,...n].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(D,{children:[r,e.jsxs(H,{style:{padding:16},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(u,{variant:"contained",onClick:()=>{F.saveAs(new Blob([m||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{U(m||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(u,{variant:"contained",onClick:()=>{F.saveAs(new Blob([S||""],{type:"text/plain;charset=utf-8"}),"genotypes.tsv")},children:"Download TSV"}),e.jsx("div",{children:e.jsx(u,{variant:"contained",onClick:()=>{y(!v)},children:v?"Hide advanced options":"Show advanced options"})})]}),v?e.jsxs("div",{children:[e.jsx(E,{variant:"h6",children:"Advanced options"}),e.jsx(G,{children:Object.entries({single:"Single",complete:"Complete"}).map(([t,n])=>e.jsx(P,{control:e.jsx(I,{checked:w===t,onChange:()=>{M(t)}}),label:n},t))})]}):null,m?e.jsx("div",{}):C?e.jsx(k.LoadingEllipses,{variant:"h6",title:"Generating genotype matrix"}):j?e.jsx(k.ErrorMessage,{error:j}):null]}),e.jsxs("div",{children:[e.jsx(E,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(_,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:x,onChange:t=>{h(t.target.value)},slotProps:{input:{classes:{input:d.textAreaFont}}}})]})]})]}),e.jsxs(L,{children:[e.jsx(u,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:t}=s;if(t)try{s.setLayout(x.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const l=t[n-1];if(!l)throw new Error(`out of bounds at ${n}`);return l}))}catch(n){console.error(n),p.getSession(s).notifyError(`${n}`,n)}i()},children:"Apply clustering"}),e.jsx(u,{variant:"contained",color:"secondary",onClick:()=>{i()},children:"Cancel"})]})]})});function B({activeMode:s,setActiveMode:i}){return e.jsxs("div",{children:[e.jsx(E,{style:{marginBottom:30},children:"This procedure will cluster the visible genotype data using hierarchical clustering"}),e.jsx(G,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([r,d])=>e.jsx(P,{control:e.jsx(I,{checked:s===r,onChange:()=>{i(r)}}),label:d},r))})]})}const Z=R(function({model:s,handleClose:i}){const[r,d]=o.useState("auto");return e.jsx(k.Dialog,{open:!0,title:"Cluster by genotype",onClose:(x,h)=>{h!=="backdropClick"&&i()},children:r==="auto"?e.jsx(J,{model:s,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:d})}):e.jsx(K,{model:s,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:d})})})});export{Z as default};
//# sourceMappingURL=ClusterDialog-BvVqHRhB.js.map

import{y as C,ag as b,bZ as S}from"./index-DPMJgfAS.js";import{B as R}from"./index-D3TbvS_u.js";function A(n,e=JSON.stringify){const s=[],t=new Set;for(const i of n){const o=e(i);t.has(o)||(s.push(i),t.add(o))}return s}function E(n){let e=0;for(const s of n)e+=s.length;return e}function O(n){const e=new Uint8Array(E(n));let s=0;for(const t of n)e.set(t,s),s+=t.length;return e}const F=65536,B=10;class T{ixxFile;ixFile;maxResults;constructor(e,s,t=20){this.ixxFile=e,this.ixFile=s,this.maxResults=t}async search(e,s){let t=[];const o=e.split(" ")[0].toLowerCase(),r=await this._getBuffer(o,s);if(!r)return[];let{end:a,buffer:u}=r,l=!1;const w=new TextDecoder("utf8");for(;!l;){const d=w.decode(u),y=d.slice(0,d.lastIndexOf(`
`)).split(`
`).filter(c=>!!c),m=[];for(const c of y){const h=c.split(" ")[0],p=h.startsWith(o);h.slice(0,o.length)>o&&(l=!0),p&&m.push(c)}const x=m.flatMap(c=>{const[h,...p]=c.split(" ");return p.map(g=>[h,g.split(",")[0]])});if(t.length+x.length<this.maxResults&&!l){const c=await this.ixFile.read(F,a,s);if(c.length===0){t=t.concat(x);break}u=O([u,c]),a+=F}else if(t.length+x.length>=this.maxResults||l){t=t.concat(x);break}}return A(t,d=>d[1]).slice(0,this.maxResults)}async getIndex(e){return(await this.ixxFile.readFile({encoding:"utf8",...e})).split(`
`).filter(t=>!!t).map(t=>{const i=t.length-B,o=t.slice(0,i),r=t.slice(i),a=Number.parseInt(r,16);return[o,a]})}async _getBuffer(e,s){let t=0,i=65536;const o=await this.getIndex(s);for(const[u,l]of o)u.slice(0,e.length)<e&&(t=l,i=l+65536);const r=i-t;return r<0?void 0:{buffer:await this.ixFile.read(r,t,s),end:i}}}function I(n){try{return decodeURIComponent(n)}catch{return n}}function L(n,e,s=15){const t=n.toLowerCase().indexOf(e);return n.length<40?n:(Math.max(0,t-s)>0?"...":"")+n.slice(Math.max(0,t-s),t+e.length+s).trim()+(t+e.length<n.length?"...":"")}class N extends R.BaseAdapter{constructor(e,s,t){super(e,s,t);const i=C.readConfObject(e,"ixFilePath"),o=C.readConfObject(e,"ixxFilePath");if(!i)throw new Error("must provide out.ix");if(!o)throw new Error("must provide out.ixx");this.trixJs=new T(b.openLocation(o,t),b.openLocation(i,t),1500)}async searchIndex(e){const s=e.queryString.toLowerCase(),t=s.split(" "),o=(await this.trixJs.search(s)).filter(([,r])=>t.every(a=>I(r).toLowerCase().includes(a))).map(([r,a])=>{const u=JSON.parse(a.replaceAll("|",",")),[l,w,...d]=u.map(f=>I(f)),y=d.findIndex(f=>!!f),m=d.map(f=>f.toLowerCase()).findIndex(f=>f.includes(r.toLowerCase())),x=d[y],c=d[m],h=m!==-1?L(c,r):void 0,p=L(x,r),g=!h||p.toLowerCase()===h.toLowerCase()?p:`${p} (${h})`;return new S({locString:l,label:x,displayString:g,matchedObject:u.map(f=>decodeURIComponent(f)),trackId:w})});return e.searchType==="exact"?o.filter(r=>r.getLabel().toLowerCase()===e.queryString.toLowerCase()):o}}export{N as default};
//# sourceMappingURL=TrixTextSearchAdapter-DvDX7YmR.js.map

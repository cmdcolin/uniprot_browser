import{u as E,ah as L,y as P,aw as F,a6 as B}from"./index-B3kPj2Rj.js";import{B as I}from"./index-CWy9Wmpn.js";import{p as O}from"./parseLineByLine-BfhM-OUE.js";import{r as j}from"./rxjs-bJg6jVuh.js";import{S as k}from"./index-B6UxCU0Z.js";import{z as v,a as R,f as $,s as z}from"./util-BvfoyAKL.js";function D(c){const t={};for(const e of c){const s=e.qname,i=e.tname,m=`${s}-${i}`;t[m]||(t[m]={quals:[],len:[]}),t[m].quals.push(e.extra.mappingQual||1),t[m].len.push(e.extra.blockLen||1)}const a=Object.fromEntries(Object.entries(t).map(([e,s])=>{const i=v(s.quals,s.len);return[e,Q(i)]}));for(const e of c){const s=e.qname,i=e.tname,m=`${s}-${i}`;e.extra.meanScore=a[m]}let n=1e4,o=0;for(const e of c)n=Math.min(e.extra.meanScore||0,n),o=Math.max(e.extra.meanScore||0,o);for(const e of c){const s=e.extra.meanScore||0;e.extra.meanScore=(s-n)/(o-n)}return c}function Q(c){const[t,a]=c.reduce(([n,o],[e,s])=>[n+e*s,o+s],[0,0]);return t/a}const{parseCigar:U}=B;class G extends I.BaseFeatureDataAdapter{async setup(t){return this.setupP||(this.setupP=this.setupPre(t).catch(a=>{throw this.setupP=void 0,a})),this.setupP}async setupPre(t){const a=[];return O.parseLineByLine(await E.fetchAndMaybeUnzip(L.openLocation(this.getConf("pafLocation"),this.pluginManager),t),n=>(a.push(R(n)),!0),t?.statusCallback),a}async hasDataForRefName(){return!0}getAssemblyNames(){const t=this.getConf("assemblyNames");if(t.length===0){const a=this.getConf("queryAssembly"),n=this.getConf("targetAssembly");return[a,n]}return t}async getRefNames(t={}){var a;const n=(a=t.regions)===null||a===void 0?void 0:a[0].assemblyName,o=await this.setup(t),e=this.getAssemblyNames().indexOf(n);if(e!==-1){const s=new Set;for(const i of o)s.add(e===0?i.qname:i.tname);return[...s]}return console.warn("Unable to do ref renaming on adapter"),[]}getFeatures(t,a={}){return j.ObservableCreate(async n=>{let o=await this.setup(a);const{config:e}=a;e&&P.readConfObject(e,"colorBy")==="meanQueryIdentity"&&(o=D(o));const s=this.getAssemblyNames(),{start:i,end:m,refName:C,assemblyName:u}=t,N=s.indexOf(u),p=N===0;N===-1&&(console.warn(`${u} not found in this adapter`),n.complete());for(let f=0;f<o.length;f++){const r=o[f];let d=0,y=0,g="",h="",x=0,b=0;p?(d=r.qstart,y=r.qend,g=r.qname,h=r.tname,x=r.tstart,b=r.tend):(d=r.tstart,y=r.tend,g=r.tname,h=r.qname,x=r.qstart,b=r.qend);const{extra:l,strand:A}=r;if(g===C&&F.doesIntersect2(i,m,d,y)){const{numMatches:S=0,blockLen:w=1,cg:W,...M}=l;let q=l.cg;l.cg&&(p&&A===-1?q=$(U(l.cg)).join(""):p&&(q=z(l.cg))),n.next(new k({uniqueId:f+u,assemblyName:u,start:d,end:y,type:"match",refName:g,strand:A,...M,CIGAR:q,syntenyId:f,identity:S/w,numMatches:S,blockLen:w,mate:{start:x,end:b,refName:h,assemblyName:s[+p]}}))}}n.complete()})}}G.capabilities=["getFeatures","getRefNames"];export{G as default};
//# sourceMappingURL=PAFAdapter-BW0bKgVa.js.map

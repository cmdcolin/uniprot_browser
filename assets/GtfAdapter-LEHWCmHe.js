import{I as w}from"./main-BPWpXae6.js";import{B as F}from"./index-CWy9Wmpn.js";import{ah as S,u as b}from"./index-B3kPj2Rj.js";import{p as A}from"./parseLineByLine-BfhM-OUE.js";import{r as L}from"./rxjs-bJg6jVuh.js";const I=["seq_name","source","featureType","start","end","score","strand","frame","attributes"];function y(s){return s===null?null:String(s).replace(/%([0-9A-Fa-f]{2})/g,(t,e)=>String.fromCharCode(parseInt(e,16)))}function O(s,t){return String(t).replace(s,e=>{let r=e.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r=`0${r}`),`%${r}`})}function v(s){return O(/[\n;\r\t=%&,\x00-\x1f\x7f-\xff]/g,s)}function $(s){return O(/[\n\r\t%\x00-\x1f\x7f-\xff]/g,s)}function j(s){if(!(s&&s.length)||s===".")return{};const t={};return s.replace(/\r?\n$/,"").slice(0,-1).split(";").forEach(e=>{if(!e)return;const r=e.trim().split(" ");if(!(r[1]&&r[1].length))return;r[0]=r[0].trim();let n=t[r[0].trim()];n||(n=[],t[r[0]]=n),n.push(...r[1].split(",").map(a=>a.trim()).map(y))}),t}function N(s){const t=s.split("	").map(r=>r==="."?null:r);t[0]=y(t[0]),t[1]=y(t[1]),t[2]=y(t[2]),t[8]=j(t[8]);const e={};for(let r=0;r<I.length;r+=1)e[I[r]]=t[r]==="."?null:t[r];return e.start!==null&&(e.start=parseInt(e.start,10)),e.end!==null&&(e.end=parseInt(e.end,10)),e.score!==null&&(e.score=parseFloat(e.score,10)),e.strand!=null&&(e.strand=e.strand),e}function D(s){const t=/^\s*##\s*(\S+)\s*(.*)/.exec(s);if(!t)return null;const e=t[1];let r=t[2];const n={directive:e};if(r.length&&(r=r.replace(/\r?\n$/,""),n.value=r),e==="sequence-region"){const[a,i,c]=r.split(/\s+/,3);n.seq_id=a,n.start=i&&i.replace(/\D/g,""),n.end=c&&c.replace(/\D/g,"")}else if(e==="genome-build"){const[a,i]=r.split(/\s+/,2);n.source=a,n.buildname=i}return n}function B(s){const t=[];return Object.keys(s).forEach(e=>{const r=s[e];let n;r.hasOwnProperty("toString")?n=v(r.toString()):Array.isArray(r.values)?n=r.values.map(v).join(","):Array.isArray(r)?n=r.map(v).join(","):n=v(r),t.push(`${v(e)} ${n}`)}),t.length?t.join("; ").concat(";"):"."}const M=["-",".","+"];function R(s,t){const e=s.attributes===null||s.attributes===void 0?".":B(s.attributes),r=[];for(let a=0;a<8;a+=1){const i=s[I[a]];a===6?r[a]=i==null?".":M[i+1]||i:r[a]=i==null?".":$(String(i))}r[8]=e;const n=`${r.join("	")}
`;return t[n]?"":(t[n]=!0,n)}function T(s,t){if(Array.isArray(s))return s.map(r=>T(r,t)).join("");const e=[R(s,t)];return["child_features","derived_features"].forEach(r=>{s[r]&&e.push(...s[r].map(n=>T(n,t)))}),e.join("")}function q(s){return T(s,{})}const E={Parent:"child_features",Derives_from:"derived_features"};class P{constructor(t){const e=()=>{};Object.assign(this,{featureCallback:t.featureCallback||e,endCallback:t.endCallback||e,commentCallback:t.commentCallback||e,errorCallback:t.errorCallback||e,directiveCallback:t.directiveCallback||e,sequenceCallback:t.sequenceCallback||e,bufferSize:t.bufferSize===void 0?1e3:t.bufferSize,_underConstructionTopLevel:[],_underConstructionById:{},_completedReferences:{},_underConstructionOrphans:{},eof:!1,lineNumber:0})}addLine(t){if(this.eof)return;if(this.lineNumber+=1,/^\s*[^#\s>]/.test(t)){this._bufferLine(t);return}const e=/^\s*(#+)(.*)/.exec(t);if(e){let[,r,n]=e;if(r.length===3)this._emitAllUnderConstructionFeatures();else if(r.length===2){const a=D(t);this._emitItem(a)}else n=n.replace(/\s*/,""),this._emitItem({comment:n})}else if(!/^\s*$/.test(t)){const r=t.replace(/\r?\n?$/g,"");throw new Error(`GTF parse error.  Cannot parse '${r}'.`)}}_emitItem(t){t[0]?this.featureCallback(t):t.directive?this.directiveCallback(t):t.comment&&this.commentCallback(t)}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_enforceBufferSizeLimit(t=0){const e=r=>{var n,a,i;!((i=(a=(n=r?.[0])===null||n===void 0?void 0:n.attributes)===null||a===void 0?void 0:a.ID)===null||i===void 0)&&i[0]&&(r[0].attributes.ID.forEach(u=>{delete this._underConstructionById[u],delete this._completedReferences[u]}),r.forEach(u=>{u.child_features&&u.child_features.forEach(o=>{e(o)}),u.derived_features&&u.derived_features.forEach(o=>{e(o)})}))};for(;this._underConstructionTopLevel.length+t>this.bufferSize;){const r=this._underConstructionTopLevel.shift();this._emitItem(r),e(r)}}_emitAllUnderConstructionFeatures(){if(this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},Object.values(this._underConstructionOrphans).filter(t=>Object.keys(t).length).length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${JSON.stringify(this._underConstructionOrphans)}`)}_bufferLine(t){const e=N(t);e.child_features=[],e.derived_features=[];const r=this.lineNumber,n=e.featureType==="transcript",a=n?e.attributes.transcript_id||[]:[r],i=n?[]:e.attributes.transcript_id||[],c=e.attributes.Derives_from||[];if(!a.length&&!i.length&&!c.length){this._emitItem([e]);return}function u(f){const l=JSON.parse(JSON.stringify(f));return l.featureType="transcript",q(l)}i.forEach(f=>{this._underConstructionById[f]||this._bufferLine(u(e))});let o;a.forEach(f=>{const l=this._underConstructionById[f];l?(l.push(e),o=l):(o=[e],this._enforceBufferSizeLimit(1),!i.length&&!c.length&&this._underConstructionTopLevel.push(o),this._underConstructionById[f]=o,this._resolveReferencesTo(o,f))}),this._resolveReferencesFrom(o||[e],{Parent:i,Derives_from:c},a)}_resolveReferencesTo(t,e){const r=this._underConstructionOrphans[e];r&&Object.keys(r).forEach(n=>{const a=E[n]||n.toLowerCase();t.forEach(i=>{i[a].push(...r[n]),delete r[n]})})}_parseError(t){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${t}`)}_resolveReferencesFrom(t,e,r){function n(i,c,u){let o=i[c];o||(o={},i[c]=o);const f=o[u]||!1;return o[u]=!0,f}function a(i,c){i[0].start=Math.min(i[0].start,c[0].start),i[0].end=Math.max(i[0].end,c[0].end)}Object.entries(e).forEach(([i,c])=>{let u;c.forEach(o=>{const f=this._underConstructionById[o];f?(a(f,t),u||(u=E[i]||i.toLowerCase()),r.filter(l=>n(this._completedReferences,l,`${i},${o}`)).length||f.forEach(l=>{l[u].push(t)})):(this._underConstructionOrphans[o]||(this._underConstructionOrphans[o]={}),this._underConstructionOrphans[o][i]||(this._underConstructionOrphans[o][i]=[]),this._underConstructionOrphans[o][i].push(t))})})}}function z(s){if(!s)return[];const t=[],e=new P({featureCallback:r=>t.push(r),errorCallback:r=>{throw r}});for(const r of s.split(/\r?\n/))e.addLine(r);return e.finish(),t}function x(s,t){const e={...s};e.start-=1,e.strand={"+":1,"-":-1,".":0,"?":void 0}[s.strand],e.phase=Number(s.frame),e.refName=s.seq_name,s.score===null&&(e.score=void 0),s.frame===null&&(e.score=void 0);const r=new Set(["start","end","seq_name","score","featureType","source","frame","strand"]);for(const n of Object.keys(s.attributes)){let a=n.toLowerCase();if(r.has(a)&&(a+="2"),s.attributes[n]){let i=s.attributes[n];Array.isArray(i)&&i.length===1&&(i=i[0].replaceAll(/^"|"$/g,"")),e[a]=i}}return e.refName=e.seq_name,e.type=e.featureType,s.child_features&&s.child_features.length>0&&(e.subfeatures=s.child_features.flatMap(n=>n.map(a=>x(a)))),e.child_features=void 0,e.data=void 0,e.derived_features=void 0,e._linehash=void 0,e.attributes=void 0,e.seq_name=void 0,e.featureType=void 0,e.frame=void 0,e.transcript_id&&(e.name=e.transcript_id),t!==void 0&&(e.uniqueId=t),e}class W extends F.BaseFeatureDataAdapter{constructor(){super(...arguments),this.calculatedIntervalTreeMap={}}async loadDataP(t){const e=S.openLocation(this.getConf("gtfLocation"),this.pluginManager),r=await b.fetchAndMaybeUnzip(e,t),n=[],a={};A.parseLineByLine(r,c=>{if(c.startsWith("#"))n.push(c);else{if(c.startsWith(">"))return!1;{const u=c.indexOf("	"),o=c.slice(0,u);a[o]||(a[o]=""),a[o]+=`${c}
`}}return!0},t?.statusCallback);const i=Object.fromEntries(Object.entries(a).map(([c,u])=>[c,o=>{if(!this.calculatedIntervalTreeMap[c]){o?.("Parsing GTF data");const f=new w;for(const l of z(u).flat().map((m,_)=>x(m,`${this.id}-${c}-${_}`)))f.insert([l.start,l.end],l);this.calculatedIntervalTreeMap[c]=f}return this.calculatedIntervalTreeMap[c]}]));return{header:n.join(`
`),intervalTreeMap:i}}async loadData(t={}){return this.gtfFeatures||(this.gtfFeatures=this.loadDataP(t).catch(e=>{throw this.gtfFeatures=void 0,e})),this.gtfFeatures}async getRefNames(t={}){const{intervalTreeMap:e}=await this.loadData(t);return Object.keys(e)}async getHeader(t={}){const{header:e}=await this.loadData(t);return e}getFeatures(t,e={}){return L.ObservableCreate(async r=>{try{await this.getFeaturesHelper({query:t,opts:e,observer:r,allowRedispatch:!0})}catch(n){r.error(n)}},e.stopToken)}async getFeaturesHelper({query:t,opts:e,observer:r,allowRedispatch:n,originalQuery:a=t}){var i;const c=this.getConf("aggregateField"),{start:u,end:o,refName:f}=t,{intervalTreeMap:l}=await this.loadData(e),m=(i=l[f])===null||i===void 0?void 0:i.call(l,e.statusCallback).search([u,o]);if(m){if(n&&m.length){let h=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,g=!1;for(const p of m)p.start<h&&(h=p.start),p.end>d&&(d=p.end),p[c]&&(g=!0);if(g&&(d>t.end||h<t.start)){await this.getFeaturesHelper({query:{...t,start:h-5e5,end:d+5e5},opts:e,observer:r,allowRedispatch:!1,originalQuery:t});return}}const _={};if(m.some(h=>h.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const h of m){const d=h[c];_[d]||(_[d]=[]),d?_[d].push(h):r.next(new b.SimpleFeature({id:h.uniqueId,data:h}))}for(const[h,d]of Object.entries(_)){const g=b.min(d.map(C=>C.start)),p=b.max(d.map(C=>C.end));if(b.doesIntersect2(g,p,a.start,a.end)){const{uniqueId:C,strand:k}=d[0];r.next(new b.SimpleFeature({id:`${C}-parent`,data:{type:"gene",subfeatures:d,strand:k,name:h,start:g,end:p,refName:t.refName}}))}}}r.complete()}}export{W as default};
//# sourceMappingURL=GtfAdapter-LEHWCmHe.js.map

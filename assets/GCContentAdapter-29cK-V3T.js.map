{"version":3,"file":"GCContentAdapter-29cK-V3T.js","sources":["../../node_modules/@jbrowse/plugin-gccontent/esm/GCContentAdapter/GCContentAdapter.js"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { SimpleFeature, updateStatus } from '@jbrowse/core/util';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport { checkStopToken } from '@jbrowse/core/util/stopToken';\nimport { firstValueFrom } from 'rxjs';\nimport { toArray } from 'rxjs/operators';\nclass GCContentAdapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.gcMode = 'content';\n    }\n    async configure() {\n        var _a;\n        const adapter = await ((_a = this.getSubAdapter) === null || _a === void 0 ? void 0 : _a.call(this, this.getConf('sequenceAdapter')));\n        if (!adapter) {\n            throw new Error('Error getting subadapter');\n        }\n        return adapter.dataAdapter;\n    }\n    async getRefNames(opts) {\n        const adapter = await this.configure();\n        return adapter.getRefNames(opts);\n    }\n    getFeatures(query, opts) {\n        const { statusCallback = () => { }, stopToken } = opts || {};\n        return ObservableCreate(async (observer) => {\n            var _a;\n            const sequenceAdapter = await this.configure();\n            const windowSize = this.getConf('windowSize');\n            const windowDelta = this.getConf('windowDelta');\n            const halfWindowSize = windowSize === 1 ? 1 : Math.ceil(windowSize / 2);\n            const isWindowSizeOneBp = windowSize === 1;\n            const qs = Math.max(0, Math.floor((query.start - halfWindowSize) / windowSize) * windowSize);\n            const qe = Math.ceil((query.end + halfWindowSize) / windowSize) * windowSize;\n            if (qe < 0 || qs > qe) {\n                observer.complete();\n                return;\n            }\n            const feats = await firstValueFrom(sequenceAdapter\n                .getFeatures({\n                ...query,\n                start: qs,\n                end: qe,\n            }, opts)\n                .pipe(toArray()));\n            const residues = ((_a = feats[0]) === null || _a === void 0 ? void 0 : _a.get('seq')) || '';\n            await updateStatus('Calculating GC', statusCallback, () => {\n                let nc = 0;\n                let ng = 0;\n                let len = 0;\n                let start = performance.now();\n                const startIdx = halfWindowSize;\n                for (let j = startIdx - halfWindowSize; j < startIdx + halfWindowSize; j++) {\n                    const letter = residues[j];\n                    if (letter === 'c' || letter === 'C') {\n                        nc++;\n                    }\n                    else if (letter === 'g' || letter === 'G') {\n                        ng++;\n                    }\n                    if (letter !== 'N') {\n                        len++;\n                    }\n                }\n                for (let i = halfWindowSize; i < residues.length - halfWindowSize; i += windowDelta) {\n                    if (performance.now() - start > 400) {\n                        checkStopToken(stopToken);\n                        start = performance.now();\n                    }\n                    if (isWindowSizeOneBp) {\n                        const letter = residues[i];\n                        nc = letter === 'c' || letter === 'C' ? 1 : 0;\n                        ng = letter === 'g' || letter === 'G' ? 1 : 0;\n                        len = letter !== 'N' ? 1 : 0;\n                    }\n                    else if (i > halfWindowSize) {\n                        const prevStart = i - windowDelta - halfWindowSize;\n                        const prevEnd = i - windowDelta + halfWindowSize;\n                        const currStart = i - halfWindowSize;\n                        const currEnd = i + halfWindowSize;\n                        for (let j = prevStart; j < Math.min(prevEnd, currStart); j++) {\n                            if (j >= 0 && j < residues.length) {\n                                const letter = residues[j];\n                                if (letter === 'c' || letter === 'C') {\n                                    nc--;\n                                }\n                                else if (letter === 'g' || letter === 'G') {\n                                    ng--;\n                                }\n                                if (letter !== 'N') {\n                                    len--;\n                                }\n                            }\n                        }\n                        for (let j = Math.max(prevEnd, currStart); j < currEnd; j++) {\n                            if (j >= 0 && j < residues.length) {\n                                const letter = residues[j];\n                                if (letter === 'c' || letter === 'C') {\n                                    nc++;\n                                }\n                                else if (letter === 'g' || letter === 'G') {\n                                    ng++;\n                                }\n                                if (letter !== 'N') {\n                                    len++;\n                                }\n                            }\n                        }\n                    }\n                    const pos = qs;\n                    const score = this.gcMode === 'content'\n                        ? (ng + nc) / (len || 1)\n                        : this.gcMode === 'skew'\n                            ? (ng - nc) / (ng + nc || 1)\n                            : 0;\n                    observer.next(new SimpleFeature({\n                        uniqueId: `${this.id}_${pos + i}`,\n                        refName: query.refName,\n                        start: pos + i,\n                        end: pos + i + windowDelta,\n                        score,\n                    }));\n                }\n            });\n            observer.complete();\n        });\n    }\n}\nGCContentAdapter.capabilities = ['hasLocalStats'];\nexport default GCContentAdapter;\n"],"names":["GCContentAdapter","BaseFeatureDataAdapter","_a","adapter","opts","query","statusCallback","stopToken","ObservableCreate","observer","sequenceAdapter","windowSize","windowDelta","halfWindowSize","isWindowSizeOneBp","qs","qe","residues","firstValueFrom","toArray","updateStatus","nc","ng","len","start","startIdx","j","letter","i","checkStopToken","prevStart","prevEnd","currStart","currEnd","pos","score","SimpleFeature"],"mappings":"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","x_google_ignoreList":[0]}
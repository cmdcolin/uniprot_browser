import{o as L,a as r,u,j as e,D as $,B as l,T,d as R,$ as E,c as A,e as F,t as O,s as I,m as q,bw as W,aU as J,f as z}from"./index-DQP-8m57.js";import{R as G}from"./RadioGroup-Bwaf1JN4.js";import{R as H}from"./Radio-DXlju-BF.js";const N=L(function({model:t,children:a,handleClose:o}){const[p,x]=r.useState(""),[h,c]=r.useState(),[v,f]=r.useState(!1),[g,C]=r.useState(""),[j,m]=r.useState(!1),[w,k]=u.useLocalStorage("cluster-samplesPerPixel","1");return e.jsxs(e.Fragment,{children:[e.jsxs($,{children:[a,e.jsxs("div",{style:{marginTop:50},children:[e.jsx(l,{variant:"contained",onClick:()=>{m(!j)},children:j?"Hide advanced options":"Show advanced options"}),j?e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(R,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:w,onChange:i=>{k(i.target.value)}})]}):null]}),e.jsxs("div",{children:[v?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:p||"Loading..."}),e.jsx(l,{onClick:()=>{E.stopStopToken(g)},children:"Stop"})]}):null,h?e.jsx(A.ErrorMessage,{error:h}):null]})]}),e.jsxs(F,{children:[e.jsx(l,{variant:"contained",disabled:v,onClick:async()=>{try{c(void 0),x("Initializing"),f(!0);const i=u.getContainingView(t);if(!i.initialized)return;const{rpcManager:S}=u.getSession(t),{sourcesWithoutLayout:y,adapterConfig:b}=t;if(y){const P=O.getRpcSessionId(t),s=E.createStopToken();C(s);const n=await S.call(P,"MultiWiggleClusterScoreMatrix",{regions:i.dynamicBlocks.contentBlocks,sources:y,sessionId:P,adapterConfig:b,stopToken:s,bpPerPx:i.bpPerPx/+w,statusCallback:d=>{x(d)}});t.setLayout(n.order.map(d=>{const M=y[d];if(!M)throw new Error(`out of bounds at ${d}`);return M}))}o()}catch(i){!u.isAbortException(i)&&I(t)&&(console.error(i),c(i))}finally{f(!1),x(""),C("")}},children:"Run clustering"}),e.jsx(l,{variant:"contained",color:"secondary",onClick:()=>{o(),g&&E.stopStopToken(g)},children:"Cancel"})]})]})}),K=q()(t=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:t.spacing(4)}})),Q=L(function({model:t,handleClose:a,children:o}){const{classes:p}=K(),[x,h]=r.useState(""),[c,v]=r.useState(),[f,g]=r.useState(),[C,j]=r.useState(!1),[m,w]=u.useLocalStorage("cluster-showAdvanced",!1),[k,i]=r.useState("single"),[S,y]=r.useState("1");r.useEffect(()=>{(async()=>{try{g(void 0),v(void 0),j(!0);const s=u.getContainingView(t),{dynamicBlocks:n,bpPerPx:d}=s,{rpcManager:M}=u.getSession(t),{sourcesWithoutLayout:V,adapterConfig:U}=t,D=O.getRpcSessionId(t),_=await M.call(D,"MultiWiggleGetScoreMatrix",{regions:n.contentBlocks,sources:V,sessionId:D,adapterConfig:U,bpPerPx:d/+S});v(_)}catch(s){!u.isAbortException(s)&&I(t)&&(console.error(s),g(s))}finally{j(!1)}})()},[t,S]);const b=c?`inputMatrix<-matrix(c(${Object.values(c).map(s=>s.join(",")).join(`,
`)}
),nrow=${Object.values(c).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(c).map(s=>`'${s}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${k}')
cat(resultClusters$order,sep='\\n')`:void 0,P=c?Object.entries(c).map(([s,n])=>[s,...n].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs($,{children:[o,e.jsxs("div",{style:{marginTop:50},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(l,{variant:"contained",onClick:()=>{W.saveAs(new Blob([b||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(l,{variant:"contained",onClick:()=>{J(b||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(l,{variant:"contained",onClick:()=>{W.saveAs(new Blob([P||""],{type:"text/plain;charset=utf-8"}),"scores.tsv")},children:"Download TSV"})]}),e.jsx("div",{children:e.jsx(l,{variant:"contained",onClick:()=>{w(!m)},children:m?"Hide advanced options":"Show advanced options"})}),m?e.jsxs("div",{children:[e.jsx(T,{variant:"h6",children:"Advanced options"}),e.jsx(G,{children:Object.entries({single:"Single",complete:"Complete"}).map(([s,n])=>e.jsx(z,{control:e.jsx(H,{checked:k===s,onChange:()=>{i(s)}}),label:n},s))}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(R,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:S,onChange:s=>{y(s.target.value)}})]})]}):null,b?e.jsx("div",{}):C?e.jsx(A.LoadingEllipses,{variant:"h6",title:"Generating score matrix"}):f?e.jsx(A.ErrorMessage,{error:f}):null]}),e.jsxs("div",{children:[e.jsx(T,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(R,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:x,onChange:s=>{h(s.target.value)},slotProps:{input:{classes:{input:p.textAreaFont}}}})]})]})]}),e.jsxs(F,{children:[e.jsx(l,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:s}=t;if(s)try{t.setLayout(x.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const d=s[n-1];if(!d)throw new Error(`out of bounds at ${n}`);return d}))}catch(n){console.error(n),u.getSession(t).notifyError(`${n}`,n)}a()},children:"Apply clustering"}),e.jsx(l,{variant:"contained",color:"secondary",onClick:()=>{a()},children:"Cancel"})]})]})});function B({activeMode:t,setActiveMode:a}){return e.jsx("div",{children:e.jsx(G,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([o,p])=>e.jsx(z,{control:e.jsx(H,{checked:t===o,onChange:()=>{a(o)}}),label:p},o))})})}const ee=L(function({model:t,handleClose:a}){const[o,p]=r.useState("auto");return e.jsx(A.Dialog,{open:!0,title:"Cluster by score",maxWidth:"xl",onClose:(x,h)=>{h!=="backdropClick"&&a()},children:o==="auto"?e.jsx(N,{model:t,handleClose:a,children:e.jsx(B,{activeMode:o,setActiveMode:p})}):e.jsx(Q,{model:t,handleClose:a,children:e.jsx(B,{activeMode:o,setActiveMode:p})})})});export{ee as default};
//# sourceMappingURL=WiggleClusterDialog-CSb3RfAx.js.map

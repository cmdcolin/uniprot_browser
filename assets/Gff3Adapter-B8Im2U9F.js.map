{"version":3,"file":"Gff3Adapter-B8Im2U9F.js","sources":["../../node_modules/@jbrowse/plugin-gff3/esm/Gff3Adapter/gffParser.js","../../node_modules/@jbrowse/plugin-gff3/esm/Gff3Adapter/Gff3Adapter.js"],"sourcesContent":["import { parseLineByLine } from '@jbrowse/core/util/parseLineByLine';\nexport function parseGffBuffer(buffer, statusCallback = () => { }) {\n    const headerLines = [];\n    const featureMap = {};\n    parseLineByLine(buffer, line => {\n        if (line.startsWith('#')) {\n            headerLines.push(line);\n        }\n        else if (line.startsWith('>')) {\n            return false;\n        }\n        else {\n            const ret = line.indexOf('\\t');\n            const refName = line.slice(0, ret);\n            if (!featureMap[refName]) {\n                featureMap[refName] = '';\n            }\n            featureMap[refName] += `${line}\\n`;\n        }\n        return true;\n    }, statusCallback);\n    return {\n        header: headerLines.join('\\n'),\n        featureMap,\n    };\n}\n","import IntervalTree from '@flatten-js/interval-tree';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { fetchAndMaybeUnzip } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport SimpleFeature from '@jbrowse/core/util/simpleFeature';\nimport { parseStringSync } from 'gff-nostream';\nimport { featureData } from '../featureData';\nimport { parseGffBuffer } from './gffParser';\nexport default class Gff3Adapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.calculatedIntervalTreeMap = {};\n    }\n    async loadDataP(opts) {\n        const { statusCallback = () => { } } = opts || {};\n        const buffer = await fetchAndMaybeUnzip(openLocation(this.getConf('gffLocation'), this.pluginManager), opts);\n        const { header, featureMap } = parseGffBuffer(buffer, statusCallback);\n        const intervalTreeMap = Object.fromEntries(Object.entries(featureMap).map(([refName, lines]) => [\n            refName,\n            (sc) => {\n                if (!this.calculatedIntervalTreeMap[refName]) {\n                    sc === null || sc === void 0 ? void 0 : sc('Parsing GFF data');\n                    const intervalTree = new IntervalTree();\n                    for (const obj of parseStringSync(lines)\n                        .flat()\n                        .map((f, i) => new SimpleFeature({\n                        data: featureData(f),\n                        id: `${this.id}-${refName}-${i}`,\n                    }))) {\n                        intervalTree.insert([obj.get('start'), obj.get('end')], obj);\n                    }\n                    this.calculatedIntervalTreeMap[refName] = intervalTree;\n                }\n                return this.calculatedIntervalTreeMap[refName];\n            },\n        ]));\n        return {\n            header,\n            intervalTreeMap,\n        };\n    }\n    async loadData(opts) {\n        if (!this.gffFeatures) {\n            this.gffFeatures = this.loadDataP(opts).catch((e) => {\n                this.gffFeatures = undefined;\n                throw e;\n            });\n        }\n        return this.gffFeatures;\n    }\n    async getRefNames(opts = {}) {\n        const { intervalTreeMap } = await this.loadData(opts);\n        return Object.keys(intervalTreeMap);\n    }\n    async getHeader(opts = {}) {\n        const { header } = await this.loadData(opts);\n        return header;\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            var _a;\n            try {\n                const { start, end, refName } = query;\n                const { intervalTreeMap } = await this.loadData(opts);\n                for (const f of ((_a = intervalTreeMap[refName]) === null || _a === void 0 ? void 0 : _a.call(intervalTreeMap, opts.statusCallback).search([\n                    start,\n                    end,\n                ])) || []) {\n                    observer.next(f);\n                }\n                observer.complete();\n            }\n            catch (e) {\n                observer.error(e);\n            }\n        }, opts.stopToken);\n    }\n}\n"],"names":["parseGffBuffer","buffer","statusCallback","headerLines","featureMap","parseLineByLine","line","ret","refName","Gff3Adapter","BaseFeatureDataAdapter","opts","fetchAndMaybeUnzip","openLocation","header","intervalTreeMap","lines","sc","intervalTree","IntervalTree","obj","parseStringSync","f","i","SimpleFeature","featureData","e","query","ObservableCreate","observer","_a","start","end"],"mappings":"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","x_google_ignoreList":[0,1]}
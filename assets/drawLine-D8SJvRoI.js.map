{"version":3,"file":"drawLine-D8SJvRoI.js","sources":["../../node_modules/@jbrowse/plugin-wiggle/esm/drawLine.js"],"sourcesContent":["import { readConfObject } from '@jbrowse/core/configuration';\nimport { clamp, featureSpanPx } from '@jbrowse/core/util';\nimport { checkStopToken } from '@jbrowse/core/util/stopToken';\nimport { getScale } from './util';\nconst fudgeFactor = 0.3;\nconst clipHeight = 2;\nexport function drawLine(ctx, props) {\n    const { features, regions, bpPerPx, scaleOpts, height: unadjustedHeight, ticks: { values }, displayCrossHatches, colorCallback, config, offset = 0, stopToken, } = props;\n    const region = regions[0];\n    const width = (region.end - region.start) / bpPerPx;\n    const height = unadjustedHeight - offset * 2;\n    const clipColor = readConfObject(config, 'clipColor');\n    const scale = getScale({ ...scaleOpts, range: [0, height] });\n    const domain = scale.domain();\n    const niceMin = domain[0];\n    const niceMax = domain[1];\n    const toY = (n) => clamp(height - (scale(n) || 0), 0, height) + offset;\n    let lastVal;\n    let prevLeftPx = Number.NEGATIVE_INFINITY;\n    const reducedFeatures = [];\n    let start = performance.now();\n    for (const feature of features.values()) {\n        if (performance.now() - start > 400) {\n            checkStopToken(stopToken);\n            start = performance.now();\n        }\n        const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx);\n        if (Math.floor(leftPx) !== Math.floor(prevLeftPx) || rightPx - leftPx > 1) {\n            reducedFeatures.push(feature);\n            prevLeftPx = leftPx;\n        }\n        const score = feature.get('score');\n        const lowClipping = score < niceMin;\n        const highClipping = score > niceMax;\n        const w = rightPx - leftPx + fudgeFactor;\n        const c = colorCallback(feature, score);\n        ctx.beginPath();\n        ctx.strokeStyle = c;\n        const startPos = lastVal !== undefined ? lastVal : score;\n        if (!region.reversed) {\n            ctx.moveTo(leftPx, toY(startPos));\n            ctx.lineTo(leftPx, toY(score));\n            ctx.lineTo(rightPx, toY(score));\n        }\n        else {\n            ctx.moveTo(rightPx, toY(startPos));\n            ctx.lineTo(rightPx, toY(score));\n            ctx.lineTo(leftPx, toY(score));\n        }\n        ctx.stroke();\n        lastVal = score;\n        if (highClipping) {\n            ctx.fillStyle = clipColor;\n            ctx.fillRect(leftPx, offset, w, clipHeight);\n        }\n        else if (lowClipping && scaleOpts.scaleType !== 'log') {\n            ctx.fillStyle = clipColor;\n            ctx.fillRect(leftPx, height - clipHeight, w, height);\n        }\n    }\n    if (displayCrossHatches) {\n        ctx.lineWidth = 1;\n        ctx.strokeStyle = 'rgba(200,200,200,0.5)';\n        for (const tick of values) {\n            ctx.beginPath();\n            ctx.moveTo(0, Math.round(toY(tick)));\n            ctx.lineTo(width, Math.round(toY(tick)));\n            ctx.stroke();\n        }\n    }\n    return {\n        reducedFeatures,\n    };\n}\n"],"names":["fudgeFactor","clipHeight","drawLine","ctx","props","features","regions","bpPerPx","scaleOpts","unadjustedHeight","values","displayCrossHatches","colorCallback","config","offset","stopToken","region","width","height","clipColor","readConfObject","scale","getScale","domain","niceMin","niceMax","toY","n","clamp","lastVal","prevLeftPx","reducedFeatures","start","feature","checkStopToken","leftPx","rightPx","featureSpanPx","score","lowClipping","highClipping","w","c","startPos","tick"],"mappings":"8DAIA,MAAMA,EAAc,GACdC,EAAa,EACZ,SAASC,EAASC,EAAKC,EAAO,CACjC,KAAM,CAAE,SAAAC,EAAU,QAAAC,EAAS,QAAAC,EAAS,UAAAC,EAAW,OAAQC,EAAkB,MAAO,CAAE,OAAAC,CAAM,EAAI,oBAAAC,EAAqB,cAAAC,EAAe,OAAAC,EAAQ,OAAAC,EAAS,EAAG,UAAAC,CAAS,EAAMX,EAC7JY,EAASV,EAAQ,CAAC,EAClBW,GAASD,EAAO,IAAMA,EAAO,OAAST,EACtCW,EAAST,EAAmBK,EAAS,EACrCK,EAAYC,EAAAA,eAAeP,EAAQ,WAAW,EAC9CQ,EAAQC,EAAS,CAAE,GAAGd,EAAW,MAAO,CAAC,EAAGU,CAAM,EAAG,EACrDK,EAASF,EAAM,OAAM,EACrBG,EAAUD,EAAO,CAAC,EAClBE,EAAUF,EAAO,CAAC,EAClBG,EAAOC,GAAMC,EAAAA,MAAMV,GAAUG,EAAMM,CAAC,GAAK,GAAI,EAAGT,CAAM,EAAIJ,EAChE,IAAIe,EACAC,EAAa,OAAO,kBACxB,MAAMC,EAAkB,CAAA,EACxB,IAAIC,EAAQ,YAAY,IAAG,EAC3B,UAAWC,KAAW5B,EAAS,SAAU,CACjC,YAAY,MAAQ2B,EAAQ,MAC5BE,EAAAA,eAAenB,CAAS,EACxBiB,EAAQ,YAAY,IAAG,GAE3B,KAAM,CAACG,EAAQC,CAAO,EAAIC,EAAAA,cAAcJ,EAASjB,EAAQT,CAAO,GAC5D,KAAK,MAAM4B,CAAM,IAAM,KAAK,MAAML,CAAU,GAAKM,EAAUD,EAAS,KACpEJ,EAAgB,KAAKE,CAAO,EAC5BH,EAAaK,GAEjB,MAAMG,EAAQL,EAAQ,IAAI,OAAO,EAC3BM,EAAcD,EAAQd,EACtBgB,EAAeF,EAAQb,EACvBgB,EAAIL,EAAUD,EAASnC,EACvB0C,EAAI9B,EAAcqB,EAASK,CAAK,EACtCnC,EAAI,UAAS,EACbA,EAAI,YAAcuC,EAClB,MAAMC,EAAWd,IAAY,OAAYA,EAAUS,EAC9CtB,EAAO,UAMRb,EAAI,OAAOiC,EAASV,EAAIiB,CAAQ,CAAC,EACjCxC,EAAI,OAAOiC,EAASV,EAAIY,CAAK,CAAC,EAC9BnC,EAAI,OAAOgC,EAAQT,EAAIY,CAAK,CAAC,IAP7BnC,EAAI,OAAOgC,EAAQT,EAAIiB,CAAQ,CAAC,EAChCxC,EAAI,OAAOgC,EAAQT,EAAIY,CAAK,CAAC,EAC7BnC,EAAI,OAAOiC,EAASV,EAAIY,CAAK,CAAC,GAOlCnC,EAAI,OAAM,EACV0B,EAAUS,EACNE,GACArC,EAAI,UAAYgB,EAChBhB,EAAI,SAASgC,EAAQrB,EAAQ2B,EAAGxC,CAAU,GAErCsC,GAAe/B,EAAU,YAAc,QAC5CL,EAAI,UAAYgB,EAChBhB,EAAI,SAASgC,EAAQjB,EAASjB,EAAYwC,EAAGvB,CAAM,EAE3D,CACA,GAAIP,EAAqB,CACrBR,EAAI,UAAY,EAChBA,EAAI,YAAc,wBAClB,UAAWyC,KAAQlC,EACfP,EAAI,UAAS,EACbA,EAAI,OAAO,EAAG,KAAK,MAAMuB,EAAIkB,CAAI,CAAC,CAAC,EACnCzC,EAAI,OAAOc,EAAO,KAAK,MAAMS,EAAIkB,CAAI,CAAC,CAAC,EACvCzC,EAAI,OAAM,CAElB,CACA,MAAO,CACH,gBAAA4B,CACR,CACA","x_google_ignoreList":[0]}
{"version":3,"file":"LinearReadVsRef-B9BhDSTZ.js","sources":["../../node_modules/@jbrowse/plugin-linear-comparative-view/esm/LinearReadVsRef/LinearReadVsRef.js"],"sourcesContent":["import { jsx as _jsx, jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { useEffect, useState } from 'react';\nimport { getConf } from '@jbrowse/core/configuration';\nimport { Dialog } from '@jbrowse/core/ui';\nimport { gatherOverlaps, getContainingView, getSession, } from '@jbrowse/core/util';\nimport { getRpcSessionId } from '@jbrowse/core/util/tracks';\nimport { MismatchParser } from '@jbrowse/plugin-alignments';\nimport { Button, CircularProgress, DialogActions, DialogContent, TextField, Typography, } from '@mui/material';\nimport { makeStyles } from 'tss-react/mui';\nconst { featurizeSA, getClip, getLength, getLengthSansClipping, getTag } = MismatchParser;\nconst useStyles = makeStyles()({\n    root: {\n        width: 300,\n    },\n});\nexport default function ReadVsRefDialog({ track, feature: preFeature, handleClose, }) {\n    const { classes } = useStyles();\n    const [windowSizeText, setWindowSize] = useState('0');\n    const [error, setError] = useState();\n    const [primaryFeature, setPrimaryFeature] = useState();\n    const windowSize = +windowSizeText;\n    useEffect(() => {\n        ;\n        (async () => {\n            setError(undefined);\n            try {\n                if (preFeature.get('flags') & 2048) {\n                    const SA = getTag(preFeature, 'SA') || '';\n                    const primaryAln = SA.split(';')[0];\n                    const [saRef, saStart] = primaryAln.split(',');\n                    const { rpcManager } = getSession(track);\n                    const adapterConfig = getConf(track, 'adapter');\n                    const sessionId = getRpcSessionId(track);\n                    const feats = (await rpcManager.call(sessionId, 'CoreGetFeatures', {\n                        adapterConfig,\n                        sessionId,\n                        regions: [\n                            {\n                                refName: saRef,\n                                start: +saStart - 1,\n                                end: +saStart,\n                            },\n                        ],\n                    }));\n                    const result = feats.find(f => f.get('name') === preFeature.get('name') &&\n                        !(f.get('flags') & 2048) &&\n                        !(f.get('flags') & 256));\n                    if (result) {\n                        setPrimaryFeature(result);\n                    }\n                    else {\n                        throw new Error('primary feature not found');\n                    }\n                }\n                else {\n                    setPrimaryFeature(preFeature);\n                }\n            }\n            catch (e) {\n                console.error(e);\n                setError(e);\n            }\n        })();\n    }, [preFeature, track]);\n    function onSubmit() {\n        var _a;\n        try {\n            if (!primaryFeature) {\n                return;\n            }\n            const feature = primaryFeature;\n            const session = getSession(track);\n            const view = getContainingView(track);\n            const cigar = feature.get('CIGAR');\n            const flags = feature.get('flags');\n            const origStrand = feature.get('strand');\n            const SA = getTag(feature, 'SA') || '';\n            const readName = feature.get('name');\n            const clipPos = getClip(cigar, 1);\n            const readAssembly = `${readName}_assembly_${Date.now()}`;\n            const [trackAssembly] = getConf(track, 'assemblyNames');\n            const assemblyNames = [trackAssembly, readAssembly];\n            const trackId = `track-${Date.now()}`;\n            const trackName = `${readName}_vs_${trackAssembly}`;\n            const { assemblyManager } = session;\n            const assembly = assemblyManager.get(trackAssembly);\n            if (!assembly) {\n                throw new Error('assembly not found');\n            }\n            const suppAlns = featurizeSA(SA, feature.id(), origStrand, readName, true);\n            const feat = feature.toJSON();\n            feat.clipPos = clipPos;\n            feat.strand = 1;\n            feat.mate = {\n                refName: readName,\n                start: clipPos,\n                end: clipPos + getLengthSansClipping(cigar),\n            };\n            const totalLength = flags & 2048 ? getLength(suppAlns[0].CIGAR) : getLength(cigar);\n            const features = [feat, ...suppAlns];\n            for (const [idx, f] of features.entries()) {\n                f.refName = assembly.getCanonicalRefName(f.refName) || f.refName;\n                f.syntenyId = idx;\n                f.mate.syntenyId = idx;\n                f.mate.uniqueId = `${f.uniqueId}_mate`;\n            }\n            features.sort((a, b) => a.clipPos - b.clipPos);\n            const featSeq = feature.get('seq');\n            const configFeatureStore = [...features, ...features.map(f => f.mate)];\n            const expand = 2 * windowSize;\n            const refLen = features.reduce((a, f) => a + f.end - f.start + expand, 0);\n            const seqTrackId = `${readName}_${Date.now()}`;\n            const sequenceTrackConf = getConf(assembly, 'sequence');\n            const lgvRegions = gatherOverlaps(features.map(f => ({\n                ...f,\n                start: Math.max(0, f.start - windowSize),\n                end: f.end + windowSize,\n                assemblyName: trackAssembly,\n            })));\n            (_a = session.addTemporaryAssembly) === null || _a === void 0 ? void 0 : _a.call(session, {\n                name: readAssembly,\n                sequence: {\n                    type: 'ReferenceSequenceTrack',\n                    name: 'Read sequence',\n                    trackId: seqTrackId,\n                    assemblyNames: [readAssembly],\n                    adapter: {\n                        type: 'FromConfigSequenceAdapter',\n                        noAssemblyManager: true,\n                        features: [\n                            {\n                                start: 0,\n                                end: totalLength,\n                                seq: featSeq || '',\n                                refName: readName,\n                                uniqueId: `${Math.random()}`,\n                            },\n                        ],\n                    },\n                },\n            });\n            session.addView('LinearSyntenyView', {\n                type: 'LinearSyntenyView',\n                views: [\n                    {\n                        type: 'LinearGenomeView',\n                        hideHeader: true,\n                        offsetPx: 0,\n                        bpPerPx: refLen / view.width,\n                        displayedRegions: lgvRegions,\n                        tracks: [\n                            {\n                                id: `${Math.random()}`,\n                                type: 'ReferenceSequenceTrack',\n                                assemblyNames: [trackAssembly],\n                                configuration: sequenceTrackConf.trackId,\n                                displays: [\n                                    {\n                                        id: `${Math.random()}`,\n                                        type: 'LinearReferenceSequenceDisplay',\n                                        showReverse: true,\n                                        showTranslation: false,\n                                        height: 35,\n                                        configuration: `${seqTrackId}-LinearReferenceSequenceDisplay`,\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                    {\n                        type: 'LinearGenomeView',\n                        hideHeader: true,\n                        offsetPx: 0,\n                        bpPerPx: totalLength / view.width,\n                        displayedRegions: [\n                            {\n                                assemblyName: readAssembly,\n                                start: 0,\n                                end: totalLength,\n                                refName: readName,\n                            },\n                        ],\n                        tracks: [\n                            {\n                                id: `${Math.random()}`,\n                                type: 'ReferenceSequenceTrack',\n                                configuration: seqTrackId,\n                                displays: [\n                                    {\n                                        id: `${Math.random()}`,\n                                        type: 'LinearReferenceSequenceDisplay',\n                                        showReverse: true,\n                                        showTranslation: false,\n                                        height: 35,\n                                        configuration: `${seqTrackId}-LinearReferenceSequenceDisplay`,\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                ],\n                viewTrackConfigs: [\n                    {\n                        type: 'SyntenyTrack',\n                        assemblyNames,\n                        adapter: {\n                            type: 'FromConfigAdapter',\n                            features: configFeatureStore,\n                        },\n                        trackId,\n                        name: trackName,\n                    },\n                ],\n                tracks: [\n                    {\n                        configuration: trackId,\n                        type: 'SyntenyTrack',\n                        displays: [\n                            {\n                                type: 'LinearSyntenyDisplay',\n                                configuration: `${trackId}-LinearSyntenyDisplay`,\n                            },\n                        ],\n                    },\n                ],\n                displayName: `${readName} vs ${trackAssembly}`,\n            });\n            handleClose();\n        }\n        catch (e) {\n            console.error(e);\n            setError(e);\n        }\n    }\n    return (_jsxs(Dialog, { open: true, onClose: handleClose, title: \"Set window size\", children: [_jsx(DialogContent, { children: error ? (_jsx(Typography, { color: \"error\", children: `${error}` })) : !primaryFeature ? (_jsxs(\"div\", { children: [_jsx(Typography, { children: \"To accurately perform comparison we are fetching the primary alignment. Loading primary feature...\" }), _jsx(CircularProgress, {})] })) : (_jsxs(\"div\", { className: classes.root, children: [primaryFeature.get('flags') & 256 ? (_jsx(Typography, { style: { color: 'orange' }, children: \"Note: You selected a secondary alignment (which generally does not have SA tags or SEQ fields) so do a full reconstruction of the alignment\" })) : null, _jsx(Typography, { children: \"Show an extra window size around each part of the split alignment. Using a larger value can allow you to see more genomic context.\" }), _jsx(TextField, { value: windowSize, onChange: event => {\n                                setWindowSize(event.target.value);\n                            }, label: \"Set window size\" })] })) }), _jsxs(DialogActions, { children: [_jsx(Button, { variant: \"contained\", color: \"secondary\", onClick: handleClose, children: \"Cancel\" }), _jsx(Button, { disabled: !primaryFeature, variant: \"contained\", color: \"primary\", onClick: onSubmit, children: \"Submit\" })] })] }));\n}\n"],"names":["featurizeSA","getClip","getLength","getLengthSansClipping","getTag","MismatchParser","useStyles","makeStyles","ReadVsRefDialog","track","preFeature","handleClose","classes","windowSizeText","setWindowSize","useState","error","setError","primaryFeature","setPrimaryFeature","windowSize","useEffect","primaryAln","saRef","saStart","rpcManager","getSession","adapterConfig","getConf","sessionId","getRpcSessionId","result","f","e","onSubmit","_a","feature","session","view","getContainingView","cigar","flags","origStrand","SA","readName","clipPos","readAssembly","trackAssembly","assemblyNames","trackId","trackName","assemblyManager","assembly","suppAlns","feat","totalLength","features","idx","b","featSeq","configFeatureStore","expand","refLen","seqTrackId","sequenceTrackConf","lgvRegions","gatherOverlaps","_jsxs","Dialog","_jsx","DialogContent","Typography","TextField","event","CircularProgress","DialogActions","Button"],"mappings":"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","x_google_ignoreList":[0]}
{"version":3,"file":"drawDotplot-DM5bZZoL.js","sources":["../../node_modules/@jbrowse/plugin-dotplot-view/esm/DotplotRenderer/drawDotplot.js"],"sourcesContent":["import { readConfObject } from '@jbrowse/core/configuration';\nimport { createJBrowseTheme } from '@jbrowse/core/ui';\nimport { bpToPx } from '@jbrowse/core/util/Base1DUtils';\nimport { MismatchParser } from '@jbrowse/plugin-alignments';\nimport { getSnapshot } from 'mobx-state-tree';\nconst { parseCigar } = MismatchParser;\nconst r = 'fell outside of range due to CIGAR string';\nconst lt = '(less than min coordinate of feature)';\nconst gt = '(greater than max coordinate of feature)';\nconst fudgeFactor = 1;\nfunction drawCir(ctx, x, y, r = 1) {\n    ctx.beginPath();\n    ctx.arc(x, y, r / 2, 0, 2 * Math.PI);\n    ctx.fill();\n}\nexport async function drawDotplot(ctx, props) {\n    var _a, _b;\n    const { config, views, height, drawCigar, theme } = props;\n    const color = readConfObject(config, 'color');\n    const posColor = readConfObject(config, 'posColor');\n    const negColor = readConfObject(config, 'negColor');\n    const colorBy = readConfObject(config, 'colorBy');\n    const lineWidth = readConfObject(config, 'lineWidth');\n    const thresholds = readConfObject(config, 'thresholds');\n    const palette = readConfObject(config, 'thresholdsPalette');\n    const isCallback = config.color.isCallback;\n    const hview = views[0];\n    const vview = views[1];\n    const db1 = (_a = hview.dynamicBlocks.contentBlocks[0]) === null || _a === void 0 ? void 0 : _a.offsetPx;\n    const db2 = (_b = vview.dynamicBlocks.contentBlocks[0]) === null || _b === void 0 ? void 0 : _b.offsetPx;\n    const warnings = [];\n    ctx.lineWidth = lineWidth;\n    const { bpPerPx: hBpPerPx } = hview;\n    const { bpPerPx: vBpPerPx } = vview;\n    function clampWithWarnX(num, min, max, feature) {\n        const strand = feature.get('strand') || 1;\n        if (strand === -1) {\n            ;\n            [max, min] = [min, max];\n        }\n        if (num < min - fudgeFactor) {\n            let start = feature.get('start');\n            let end = feature.get('end');\n            const refName = feature.get('refName');\n            if (strand === -1) {\n                ;\n                [end, start] = [start, end];\n            }\n            warnings.push({\n                message: `feature at (X ${refName}:${start}-${end}) ${r} ${lt}`,\n                effect: 'clipped the feature',\n            });\n            return min;\n        }\n        if (num > max + fudgeFactor) {\n            const strand = feature.get('strand') || 1;\n            const start = strand === 1 ? feature.get('start') : feature.get('end');\n            const end = strand === 1 ? feature.get('end') : feature.get('start');\n            const refName = feature.get('refName');\n            warnings.push({\n                message: `feature at (X ${refName}:${start}-${end}) ${r} ${gt}`,\n                effect: 'clipped the feature',\n            });\n            return max;\n        }\n        return num;\n    }\n    function clampWithWarnY(num, min, max, feature) {\n        if (num < min - fudgeFactor) {\n            const mate = feature.get('mate');\n            const { refName, start, end } = mate;\n            warnings.push({\n                message: `feature at (Y ${refName}:${start}-${end}) ${r} ${lt}`,\n                effect: 'clipped the feature',\n            });\n            return min;\n        }\n        if (num > max + fudgeFactor) {\n            const mate = feature.get('mate');\n            const { refName, start, end } = mate;\n            warnings.push({\n                message: `feature at (Y ${refName}:${start}-${end}) ${r} ${gt}`,\n                effect: 'clipped the feature',\n            });\n            return max;\n        }\n        return num;\n    }\n    const hsnap = {\n        ...getSnapshot(hview),\n        staticBlocks: hview.staticBlocks,\n        width: hview.width,\n    };\n    const vsnap = {\n        ...getSnapshot(vview),\n        staticBlocks: vview.staticBlocks,\n        width: vview.width,\n    };\n    const t = createJBrowseTheme(theme);\n    for (const feature of hview.features || []) {\n        const strand = feature.get('strand') || 1;\n        const start = strand === 1 ? feature.get('start') : feature.get('end');\n        const end = strand === 1 ? feature.get('end') : feature.get('start');\n        const refName = feature.get('refName');\n        const mate = feature.get('mate');\n        const mateRef = mate.refName;\n        let r = 'black';\n        if (colorBy === 'identity') {\n            const identity = feature.get('identity');\n            for (let i = 0; i < thresholds.length; i++) {\n                if (identity > +thresholds[i]) {\n                    r = palette[i] || 'black';\n                    break;\n                }\n            }\n        }\n        else if (colorBy === 'meanQueryIdentity') {\n            r = `hsl(${feature.get('meanScore') * 200},100%,40%)`;\n        }\n        else if (colorBy === 'mappingQuality') {\n            r = `hsl(${feature.get('mappingQual')},100%,40%)`;\n        }\n        else if (colorBy === 'strand') {\n            r = strand === -1 ? negColor : posColor;\n        }\n        else if (colorBy === 'default') {\n            r = isCallback\n                ? readConfObject(config, 'color', { feature })\n                : color === '#f0f'\n                    ? t.palette.text.primary\n                    : color;\n        }\n        ctx.fillStyle = r;\n        ctx.strokeStyle = r;\n        const b10 = bpToPx({ self: hsnap, refName, coord: start });\n        const b20 = bpToPx({ self: hsnap, refName, coord: end });\n        const e10 = bpToPx({ self: vsnap, refName: mateRef, coord: mate.start });\n        const e20 = bpToPx({ self: vsnap, refName: mateRef, coord: mate.end });\n        if (b10 !== undefined &&\n            b20 !== undefined &&\n            e10 !== undefined &&\n            e20 !== undefined) {\n            const b1 = b10.offsetPx - db1;\n            const b2 = b20.offsetPx - db1;\n            const e1 = e10.offsetPx - db2;\n            const e2 = e20.offsetPx - db2;\n            if (Math.abs(b1 - b2) <= 4 && Math.abs(e1 - e2) <= 4) {\n                drawCir(ctx, b1, height - e1, lineWidth);\n            }\n            else {\n                let currX = b1;\n                let currY = e1;\n                const cigar = feature.get('CIGAR');\n                if (drawCigar && cigar) {\n                    const cigarOps = parseCigar(cigar);\n                    ctx.beginPath();\n                    ctx.moveTo(currX, height - currY);\n                    let lastDrawnX = currX;\n                    let lastDrawnY = currX;\n                    for (let i = 0; i < cigarOps.length; i += 2) {\n                        const val = +cigarOps[i];\n                        const op = cigarOps[i + 1];\n                        if (op === 'M' || op === '=' || op === 'X') {\n                            currX += (val / hBpPerPx) * strand;\n                            currY += val / vBpPerPx;\n                        }\n                        else if (op === 'D' || op === 'N') {\n                            currX += (val / hBpPerPx) * strand;\n                        }\n                        else if (op === 'I') {\n                            currY += val / vBpPerPx;\n                        }\n                        currX = clampWithWarnX(currX, b1, b2, feature);\n                        currY = clampWithWarnY(currY, e1, e2, feature);\n                        if (Math.abs(currX - lastDrawnX) > 0.5 ||\n                            Math.abs(currY - lastDrawnY) > 0.5) {\n                            ctx.lineTo(currX, height - currY);\n                            lastDrawnX = currX;\n                            lastDrawnY = currY;\n                        }\n                    }\n                    ctx.stroke();\n                }\n                else {\n                    ctx.beginPath();\n                    ctx.moveTo(b1, height - e1);\n                    ctx.lineTo(b2, height - e2);\n                    ctx.stroke();\n                }\n            }\n        }\n        else {\n            if (warnings.length <= 5) {\n                if (b10 === undefined || b20 === undefined) {\n                    warnings.push({\n                        message: `feature at (X ${refName}:${start}-${end}) not plotted, fell outside of range`,\n                        effect: 'feature not rendered',\n                    });\n                }\n                else {\n                    warnings.push({\n                        message: `feature at (Y ${mateRef}:${mate.start}-${mate.end}) not plotted, fell outside of range`,\n                        effect: 'feature not rendered',\n                    });\n                }\n            }\n        }\n    }\n    return { warnings };\n}\n"],"names":["parseCigar","MismatchParser","r","lt","gt","fudgeFactor","drawCir","ctx","x","y","drawDotplot","props","_a","_b","config","views","height","drawCigar","theme","color","readConfObject","posColor","negColor","colorBy","lineWidth","thresholds","palette","isCallback","hview","vview","db1","db2","warnings","hBpPerPx","vBpPerPx","clampWithWarnX","num","min","max","feature","strand","start","end","refName","clampWithWarnY","mate","hsnap","getSnapshot","vsnap","t","createJBrowseTheme","mateRef","identity","i","b10","bpToPx","b20","e10","e20","b1","b2","e1","e2","currX","currY","cigar","cigarOps","lastDrawnX","lastDrawnY","val","op"],"mappings":"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","x_google_ignoreList":[0]}
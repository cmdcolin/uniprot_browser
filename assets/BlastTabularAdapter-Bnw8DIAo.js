import{y as L,u as S,ah as v}from"./index-B3kPj2Rj.js";import{B as R}from"./index-CWy9Wmpn.js";import{p as D}from"./parseLineByLine-BfhM-OUE.js";import{r as F}from"./rxjs-bJg6jVuh.js";import{S as j}from"./index-B6UxCU0Z.js";function T(N){const e=N.trim().split(" "),t=e.indexOf("qseqid");if(t===-1)throw new Error('Missing required column "qseqid"');const s=e.indexOf("sseqid");if(s===-1)throw new Error('Missing required column "sseqid"');const d=e.indexOf("qstart");if(d===-1)throw new Error('Missing required column "qstart"');const n=e.indexOf("qend");if(n===-1)throw new Error('Missing required column "qend"');const r=e.indexOf("sstart");if(r===-1)throw new Error('Missing required column "sstart"');const f=e.indexOf("send");if(f===-1)throw new Error('Missing required column "send"');const q=new Map(e.map((c,a)=>[c,a]).filter(c=>!["qseqid","sseqid","qstart","qend","sstart","send"].includes(c[0])));return c=>{if(c.startsWith("#"))return;const a=c.split("	"),l=a[t],b=a[s],i=a[d],o=a[n],y=a[r],p=a[f];if(!(l&&b&&i&&o&&y&&p)){console.warn("Invalid BLAST line"),console.warn(c);return}const m={qseqid:l,sseqid:b,qstart:Number.parseInt(i),qend:Number.parseInt(o),sstart:Number.parseInt(y),send:Number.parseInt(p)};for(const[u,g]of q.entries()){const h=a[g];h&&(m[u]=h)}return m}}class U extends R.BaseFeatureDataAdapter{getData(e){return this.data||(this.data=this.setup(e).catch(t=>{throw this.data=void 0,t})),this.data}async setup(e){const t=L.readConfObject(this.config,"columns"),s=[],d=T(t);return D.parseLineByLine(await S.fetchAndMaybeUnzip(v.openLocation(L.readConfObject(this.config,"blastTableLocation"),this.pluginManager),e),n=>{const r=d(n);return r&&s.push(r),!0},e?.statusCallback),s}async hasDataForRefName(){return!0}getAssemblyNames(){const e=this.getConf("assemblyNames");if(e.length===0){const t=this.getConf("queryAssembly"),s=this.getConf("targetAssembly");return[t,s]}return e}async getRefNames(e={}){var t;const s=(t=e.regions)===null||t===void 0?void 0:t[0].assemblyName,d=await this.getData(e),n=this.getAssemblyNames().indexOf(s);if(n!==-1){const r=new Set;for(const f of d)r.add(n===0?f.qseqid:f.sseqid);return[...r]}return console.warn("Unable to do ref renaming on adapter"),[]}getFeatures(e,t={}){return F.ObservableCreate(async s=>{const d=await this.getData(t),[n,r]=this.getAssemblyNames(),{refName:f,assemblyName:q,start:c,end:a}=e;if(q!==r&&q!==n){console.warn(`${q} not found in this adapter`),s.complete();return}for(let l=0;l<d.length;l++){const b=d[l];let i,o,y,p,m,u,g,h;const{qseqid:x,sseqid:w,qstart:A,qend:E,sstart:I,send:O,...C}=b;q===n?(i=A,o=E,y=x,p=n,m=I,u=O,g=w,h=r):(i=I,o=O,y=w,p=r,m=A,u=E,g=x,h=n);let M=1,B=1;i>o&&([i,o]=[o,i],M=-1),m>u&&([m,u]=[u,m],B=-1),y===f&&S.doesIntersect2(c,a,i,o)&&s.next(new j({uniqueId:l+q,assemblyName:p,start:i,end:o,type:"match",refName:y,strand:M*B,syntenyId:l,...C,mate:{start:m,end:u,refName:g,assemblyName:h}}))}s.complete()})}}U.capabilities=["getFeatures","getRefNames"];export{U as default};
//# sourceMappingURL=BlastTabularAdapter-Bnw8DIAo.js.map
